# Traffic Geneator specs

## Introduction

**The traffic generator is based on the following concepts**

* python code
* Re-execute a reference traffic of about 1h that has been previously recorded.
    This re-excution will be in the form of a POST sent to the existing Acquisition servlet.
* Duplicate this traffic for as many users as defined in the start command.

**Overall Algorithm**

* When the traffic generator start, it looks into the `<traffic_ref_path>` directory and parse the different file name.
* Each of these file is a single POST JSON pushed by the Mobile_Apps, for a given user.
* The idea is to **start** the user thread one by one in sequence (seperated by random (poisson) amount of time ).
* Once they are started, they work in parallel with the same logic.
* Algorithm is

      while (not end of `<nb_users>`)
        Start user thread `n`
        Wait for a random duration (poisson distribution for which `lamda = 1/<lambd_inv>`)

* Each user_thread does the following (all threads in // doing the same thing)

      load fileName_index_1
      while (not end of file list):
          Update the userid (mail_address) to match the user_thread
          POST the updated JSON to acquisition Servlet
          load fileName_index_n+1
          Sleep 1mn +/- random (3s)
          if (I'm reaching the `<duration_test>`):
            exit while loop

## Start command

* `rta_traffic_gen <nb_users> <traffic_ref_path> <duration_test> <lambd_inv>`
  * `<nb_users>`: (int) matches the number of simulated users sending traffic in //
  * `<traffic_ref_path>`: the file system path where the traffic reference files are stored
  * `<duration_test>`: Life_time (in miliseconds) of each individual user thread (the same for all of them)
  * `<lambd_inv>`: The average duration (in seconds) between each user thread startup (poisson distribution)
  * `<post_url>`: The URL where the traffic generator will POST the traffic. The post has to contain a `application/json` content-type.

## Details

**traffic reference file**

* Each file is JSON formated. It contains a 1mn traffic generated by the MSband-2
* The file name format is: `<index>_msbandraw_<time>`
  * `<index>` is an integer from 1 --> ~ 60 (1 / min)
  * `<time>` is the timestamp (ms) when this raw data was generated. This value is just for information, as the `<index>` will be used to load in sequence the JSON files.


**`<lambd_inv>`**

* We will use a poisson distribution random generator for defining the amount of time between each thread startup
* for example if `<lambd_inv> = 15` this means that we will wait in mean 15s between each user thread start.
* For getting this "waiting duration" between each user thread start we will use the python `random.expovariate(1/<lambd_inv>)` library
* With `<lambd_inv> = 15` python `random.expovariate(1/<lambd_inv>)` will return a value "around" 15s which will be the duration to wait for starting the next user thread.


**tests**

* The servlet
  * endpoint to which the POST(DEV): http://c2t08978.itcs.hpecorp.net:9797/simpleiothttp2kafka/
  * management page (to trace the posted content): http://c2t08978.itcs.hpecorp.net:9797/simpleiothttp2kafka/rta_msband_mon
